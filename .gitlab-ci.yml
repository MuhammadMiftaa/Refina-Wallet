# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/HEAD/app/assets/javascripts/editor/schema/ci.json

stages:
  - build
  - release
  - deploy
  - migrate

variables:
  TAG_IMAGE: $CI_COMMIT_TAG

build_refina_auth:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - echo "Building Refina Auth Backend Application..."
    - docker build -t "$CI_REGISTRY_IMAGE/refina-auth:$TAG_IMAGE" .
    - docker push "$CI_REGISTRY_IMAGE/refina-auth:$TAG_IMAGE"
    - echo "$CI_JOB_ID" > refina-auth_build_job_id.txt
  artifacts:
    paths:
      - refina-auth_build_job_id.txt

build_migrate:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - echo "Building migration image..."
    - docker build -f Dockerfile.migrate -t "$CI_REGISTRY_IMAGE/migrate:$TAG_IMAGE" .
    - docker push "$CI_REGISTRY_IMAGE/migrate:$TAG_IMAGE"
    - echo "$CI_JOB_ID" > migrate_build_job_id.txt
  artifacts:
    paths:
      - migrate_build_job_id.txt

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build_refina_auth
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  variables:
    RELEASE_TITLE: "Release ${CI_COMMIT_TAG}"
    RELEASE_DESC: "Tagged after commit ${CI_COMMIT_SHORT_SHA}, message ${CI_COMMIT_TAG_MESSAGE}"
  script:
    - export REFINA_AUTH_JOB_ID="$(cat refina-auth_build_job_id.txt)"
    - echo "create release ${CI_COMMIT_TAG} from jobs $REFINA_AUTH_JOB_ID"
    - release-cli create --name "${RELEASE_TITLE}" --description "${RELEASE_DESC}" --tag-name "${CI_COMMIT_TAG}"

deploy-staging:
  stage: deploy
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  before_script:
    - "which ssh-agent || ( apk update && apk add --no-cache openssh)"
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 700 ~/.ssh/id_rsa
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - |
      ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "
        export STG_REFINA_AUTH_IMAGE="$CI_REGISTRY_IMAGE/refina-auth" &&
        export STG_REFINA_AUTH_IMAGE_TAG=$TAG_IMAGE &&

        cd ~/web/staging/refinamicroservices &&

        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        docker compose -f docker-compose.yml pull stg-refina-auth &&
        docker compose -f docker-compose.yml up -d stg-refina-auth
      "

deploy-production:
  stage: deploy
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  before_script:
    - "which ssh-agent || ( apk update && apk add --no-cache openssh)"
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 700 ~/.ssh/id_rsa
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - |
      ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} " 
        export PROD_REFINA_AUTH_IMAGE="$CI_REGISTRY_IMAGE/refina-auth" &&
        export PROD_REFINA_AUTH_IMAGE_TAG=$TAG_IMAGE &&

        cd ~/web/production/refinamicroservices &&

        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        docker compose -f docker-compose.yml pull prod-refina-auth &&
        docker compose -f docker-compose.yml up -d prod-refina-auth
      "
  when: manual

migrate-staging:
  stage: migrate
  image: alpine:latest
  needs:
    - job: build_migrate
      artifacts: true
    - job: deploy-staging
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  before_script:
    - "which ssh-agent || ( apk update && apk add --no-cache openssh)"
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 700 ~/.ssh/id_rsa
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - |
      ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "
        export APP_IMAGE_STG_MIGRATE=\"$CI_REGISTRY_IMAGE/migrate\" &&
        export APP_IMAGE_STG_MIGRATE_TAG=$TAG_IMAGE &&

        cd ~/web/staging/refinamicroservices &&

        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        docker pull $CI_REGISTRY_IMAGE/migrate:$TAG_IMAGE &&
        
        echo 'Running database migration for staging environment...' &&
        docker compose -f docker-compose.yml run --rm stg-refina-auth-migrate
        
        echo 'Migration completed for staging environment'
      "
  when: manual

migrate-production:
  stage: migrate
  image: alpine:latest
  needs:
    - job: build_migrate
      artifacts: true
    - job: deploy-production
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]{4}\.[0-9]{1,3}$/
  before_script:
    - "which ssh-agent || ( apk update && apk add --no-cache openssh)"
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 700 ~/.ssh/id_rsa
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - |
      ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "
        export APP_IMAGE_PROD_MIGRATE=\"$CI_REGISTRY_IMAGE/migrate\" &&
        export APP_IMAGE_PROD_MIGRATE_TAG=$TAG_IMAGE &&

        cd ~/web/production/refinamicroservices &&

        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        docker pull $CI_REGISTRY_IMAGE/migrate:$TAG_IMAGE &&
        
        echo 'Running database migration for production environment...' &&
        docker compose -f docker-compose.yml run --rm prod-refina-auth-migrate

        echo 'Migration completed for production environment'
      "
  when: manual